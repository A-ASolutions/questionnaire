<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Questionnaires | Meaningful Path Therapy</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2430;
      --muted:#667085;
      --line:#e6e8ee;
      --accent:#2f6fed;
      --accent2:#1f5bd8;
      --danger:#b42318;
      --shadow: 0 10px 30px rgba(16, 24, 40, 0.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    .header{
      position: sticky;
      top: 0;
      z-index: 50;
      background: color-mix(in oklab, var(--bg) 92%, white 8%);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .header-inner{
      max-width: 920px;
      margin: 0 auto;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand .title{font-weight: 750; letter-spacing:-0.02em;}
    .brand .subtitle{color: var(--muted); font-size: 0.92rem;}
    .badge{
      font-size: 0.85rem;
      color: var(--muted);
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      background: white;
      white-space: nowrap;
    }

    .container{
      max-width: 920px;
      margin: 0 auto;
      padding: 22px 16px 56px;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .stack{display:flex; flex-direction:column; gap: 14px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }
    .col-12{grid-column: span 12;}
    .col-6{grid-column: span 6;}
    @media (max-width: 720px){ .col-6{grid-column: span 12;} }

    .kicker{font-size: 0.85rem; color: var(--muted); text-transform: uppercase; letter-spacing:0.08em;}
    .h1{font-size: 1.4rem; margin: 0; letter-spacing:-0.02em;}
    .h2{font-size: 1.1rem; margin: 0; letter-spacing:-0.02em;}
    .small{font-size: 0.92rem; color: var(--muted);}

    .notice{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fbfcff;
      color: var(--muted);
      font-size: 0.93rem;
    }
    .notice strong{color: var(--text);}

    .field label{display:block; font-weight: 650; margin-bottom: 6px;}
    .req{color: var(--danger);}
    input[type="text"], select, textarea{
      width: 100%;
      padding: 12px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font: inherit;
      outline: none;
      background: white;
    }
    textarea{min-height: 84px; resize: vertical;}
    input[type="text"]:focus, select:focus, textarea:focus{
      border-color: color-mix(in oklab, var(--accent) 60%, var(--line) 40%);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 15%, transparent 85%);
    }

    .stepper{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .step{
      border: 1px solid var(--line);
      background: white;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.86rem;
      color: var(--muted);
    }
    .step.is-active{
      border-color: color-mix(in oklab, var(--accent) 55%, var(--line) 45%);
      background: color-mix(in oklab, var(--accent) 10%, white 90%);
      color: var(--text);
      font-weight: 650;
    }
    .step.is-done{
      border-color: color-mix(in oklab, var(--accent) 35%, var(--line) 65%);
      color: var(--text);
    }

    .progress-wrap{display:flex; align-items:center; gap: 10px;}
    .progress{
      flex:1;
      height: 8px;
      background: #eef1f7;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid var(--line);
    }
    .progress > div{
      height: 100%;
      width: 0%;
      background: var(--accent);
    }

    .question{
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: white;
    }
    .q-title{font-weight: 650; margin: 0 0 10px;}
    .choices{display:flex; flex-wrap: wrap; gap: 8px;}
    .choice{
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      user-select:none;
      background: #fbfcff;
      transition: transform .04s ease, border-color .12s ease, background .12s ease;
      font-size: 0.95rem;
    }
    .choice:hover{transform: translateY(-1px);}
    .choice input{display:none;}
    .choice.is-selected{
      border-color: color-mix(in oklab, var(--accent) 70%, var(--line) 30%);
      background: color-mix(in oklab, var(--accent) 10%, white 90%);
    }

    .actions{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .btn{
      border: none;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 750;
      cursor: pointer;
      background: var(--accent);
      color: white;
    }
    .btn:hover{background: var(--accent2);}
    .btn:disabled{opacity:.65; cursor: default;}
    .btn-ghost{
      background: white;
      color: var(--text);
      border: 1px solid var(--line);
    }
    .btn-ghost:hover{background: #f8f9fc;}
    .result-box{
      background: #e8f0ff;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 0.95rem;
      border: 1px solid var(--line);
    }
    .alert{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid color-mix(in oklab, var(--danger) 30%, var(--line) 70%);
      background: color-mix(in oklab, var(--danger) 7%, white 93%);
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="title">Meaningful Path Therapy</div>
        <div class="subtitle">Questionnaires (PHQ-9 • GAD-7 • IES-R)</div>
      </div>
      <div class="badge" id="initialsBadge">Initials: —</div>
    </div>
  </div>

  <div class="container stack">

    <div class="card stack">
      <div class="stepper" id="stepper"></div>

      <div class="progress-wrap">
        <div class="progress"><div id="progressBar"></div></div>
        <div class="badge" id="progressLabel">0%</div>
      </div>

      <div class="notice" id="stepIntro"></div>
    </div>

    <!-- One form, one final submit -->
    <form id="wizardForm" class="card stack" method="POST"
          action="https://formsubmit.co/meaningfulpaththerapy@gmail.com">
      <!-- FormSubmit helpers -->
      <input type="hidden" name="_subject" id="_subject" value="">
      <input type="hidden" name="_next" value="./thankyou.html">
      <textarea name="summary" id="summary" style="display:none;"></textarea>

      <!-- STEP 0: Start -->
      <section id="step-0" class="stack">
        <div>
          <div class="kicker">Start</div>
          <h1 class="h1">Enter your initials</h1>
          <p class="small">You’ll complete one questionnaire at a time. At the end, everything will be submitted together.</p>
        </div>

        <div class="grid">
          <div class="col-6 field">
            <label for="initials">Initials <span class="req">*</span></label>
            <input id="initials" name="initials" type="text" maxlength="10" required>
            <div class="small">Example: AA</div>
          </div>
          <div class="col-6 field">
            <label for="ageBand">Age band (optional)</label>
            <select id="ageBand" name="ageBand">
              <option value="">Prefer not to say</option>
              <option value="18-24">18–24</option>
              <option value="25-34">25–34</option>
              <option value="35-44">35–44</option>
              <option value="45-54">45–54</option>
              <option value="55+">55+</option>
            </select>
          </div>

          <div class="col-12 field">
            <label style="font-weight:400;">
              <input type="checkbox" id="consent" required>
              I agree to share these questionnaire results with my therapist.
            </label>
          </div>
        </div>

        <div class="alert">
          <strong>Note:</strong> Do not use this form for emergencies. If you are at immediate risk, contact local emergency services.
        </div>
      </section>

      <!-- STEP 1: PHQ-9 -->
      <section id="step-1" class="stack" style="display:none;">
        <div>
          <div class="kicker">PHQ-9</div>
          <h2 class="h2">Mood (past 2 weeks)</h2>
        </div>
        <div id="phq9Questions" class="stack"></div>
      </section>

      <!-- STEP 2: GAD-7 -->
      <section id="step-2" class="stack" style="display:none;">
        <div>
          <div class="kicker">GAD-7</div>
          <h2 class="h2">General anxiety (past 2 weeks)</h2>
        </div>
        <div id="gad7Questions" class="stack"></div>
      </section>

      <!-- STEP 3: IES-R -->
      <section id="step-3" class="stack" style="display:none;">
        <div>
          <div class="kicker">IES-R</div>
          <h2 class="h2">Impact of Event (past 7 days)</h2>
          <p class="small">With respect to the event you have in mind.</p>
        </div>

        <div class="field">
          <label for="eventDesc">Brief description of the event (optional)</label>
          <textarea id="eventDesc" name="eventDesc" placeholder="e.g. accident, loss, assault (no details needed)"></textarea>
          <div class="small">Please avoid including identifying details.</div>
        </div>

        <div id="iesrQuestions" class="stack"></div>
      </section>

      <!-- STEP 4: Review + Submit -->
      <section id="step-4" class="stack" style="display:none;">
        <div>
          <div class="kicker">Review</div>
          <h2 class="h2">Ready to submit</h2>
          <p class="small">This will send all results together to your therapist.</p>
        </div>

        <div id="reviewBox" class="result-box"></div>

        <div class="notice">
          <strong>Reminder:</strong> If item 9 on PHQ-9 indicates thoughts of self-harm, please contact emergency services or local crisis support.
        </div>
      </section>

      <div class="actions">
        <button type="button" class="btn btn-ghost" id="backBtn">Back</button>
        <button type="button" class="btn" id="nextBtn">Next</button>
      </div>
    </form>
  </div>

  <script>
    // ---------- Data ----------
    const steps = [
      { key: "start", label: "Start", intro: "Enter initials once, then complete each questionnaire. Submit once at the end." },
      { key: "phq9", label: "PHQ-9", intro: "PHQ-9: Over the last 2 weeks, how often have you been bothered by any of the following problems?" },
      { key: "gad7", label: "GAD-7", intro: "GAD-7: Over the last 2 weeks, how often have you been bothered by the following problems?" },
      { key: "iesr", label: "IES-R", intro: "IES-R: During the past 7 days, how distressing has each item been with respect to the event you have in mind?" },
      { key: "review", label: "Review", intro: "Review your scores, then submit all results together." }
    ];

    const phq9Items = [
      "Little interest or pleasure in doing things",
      "Feeling down, depressed, or hopeless",
      "Trouble falling or staying asleep, or sleeping too much",
      "Feeling tired or having little energy",
      "Poor appetite or overeating",
      "Feeling bad about yourself, or that you are a failure or have let yourself or your family down",
      "Trouble concentrating on things, such as reading or watching TV",
      "Moving or speaking so slowly that other people could have noticed, or the opposite – being so fidgety or restless that you have been moving around a lot more than usual",
      "Thoughts that you would be better off dead, or thoughts of hurting yourself in some way"
    ];

    const gad7Items = [
      "Feeling nervous, anxious, or on edge",
      "Not being able to stop or control worrying",
      "Worrying too much about different things",
      "Trouble relaxing",
      "Being so restless that it is hard to sit still",
      "Becoming easily annoyed or irritable",
      "Feeling afraid as if something awful might happen"
    ];

    const iesrItems = [
      "Any reminder brought back feelings about it",
      "I had trouble staying asleep",
      "Other things kept making me think about it",
      "I felt irritable and angry",
      "I avoided letting myself get upset when I thought about it or was reminded of it",
      "I thought about it when I didn't mean to",
      "I felt as if it hadn't happened or wasn't real",
      "I stayed away from reminders of it",
      "Pictures about it popped into my mind",
      "I was jumpy and easily startled",
      "I tried not to think about it",
      "I was aware that I still had a lot of feelings about it, but I didn't deal with them",
      "My feelings about it were kind of numb",
      "I found myself acting or feeling like I was back at that time",
      "I had trouble falling asleep",
      "I had waves of strong feelings about it",
      "I tried to remove it from my memory",
      "I had trouble concentrating",
      "Reminders of it caused me to have physical reactions (e.g. sweating, trouble breathing, nausea, pounding heart)",
      "I had dreams about it",
      "I felt watchful and on guard",
      "I tried not to talk about it"
    ];

    const phqGadOptions = [
      { value: 0, label: "Not at all (0)" },
      { value: 1, label: "Several days (1)" },
      { value: 2, label: "More than half the days (2)" },
      { value: 3, label: "Nearly every day (3)" }
    ];

    const iesrOptions = [
      { value: 0, label: "Not at all (0)" },
      { value: 1, label: "A little bit (1)" },
      { value: 2, label: "Moderately (2)" },
      { value: 3, label: "Quite a bit (3)" },
      { value: 4, label: "Extremely (4)" }
    ];

    // ---------- Helpers ----------
    const $ = (s) => document.querySelector(s);

    function isoDate(){
      return new Date().toISOString().slice(0,10);
    }

    function setInitialsBadge(){
      const initials = ($("#initials")?.value || "").trim();
      $("#initialsBadge").textContent = initials ? `Initials: ${initials}` : "Initials: —";
    }

    function renderQuestions(containerId, items, prefix, options){
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      items.forEach((text, idx) => {
        const n = idx + 1;
        const name = `${prefix}_q${n}`;

        const wrap = document.createElement("div");
        wrap.className = "question";

        const p = document.createElement("p");
        p.className = "q-title";
        p.textContent = `${n}. ${text}`;
        wrap.appendChild(p);

        const choices = document.createElement("div");
        choices.className = "choices";

        options.forEach(opt => {
          const label = document.createElement("label");
          label.className = "choice";

          const input = document.createElement("input");
          input.type = "radio";
          input.name = name;
          input.value = opt.value;

          input.addEventListener("change", () => {
            [...choices.querySelectorAll(".choice")].forEach(c => c.classList.remove("is-selected"));
            label.classList.add("is-selected");
            updateOverallProgress();
          });

          label.appendChild(input);
          label.appendChild(document.createTextNode(opt.label));
          choices.appendChild(label);
        });

        wrap.appendChild(choices);
        container.appendChild(wrap);
      });
    }

    function getAnswers(prefix, count){
      const answers = [];
      let total = 0;
      for (let i=1; i<=count; i++){
        const el = document.querySelector(`input[name="${prefix}_q${i}"]:checked`);
        if (!el) return null;
        const v = parseInt(el.value, 10);
        answers.push(v);
        total += v;
      }
      return { total, answers };
    }

    function phqSeverity(score){
      if (score <= 4) return "Minimal";
      if (score <= 9) return "Mild";
      if (score <= 14) return "Moderate";
      if (score <= 19) return "Moderately severe";
      return "Severe";
    }

    function gadSeverity(score){
      if (score <= 4) return "Minimal";
      if (score <= 9) return "Mild";
      if (score <= 14) return "Moderate";
      return "Severe";
    }

    function buildStepper(activeIndex){
      const el = $("#stepper");
      el.innerHTML = "";
      steps.forEach((s, idx) => {
        const pill = document.createElement("div");
        pill.className = "step";
        pill.textContent = s.label;
        if (idx === activeIndex) pill.classList.add("is-active");
        if (idx < activeIndex) pill.classList.add("is-done");
        el.appendChild(pill);
      });
    }

    function totalQuestions(){
      return phq9Items.length + gad7Items.length + iesrItems.length;
    }

    function answeredCount(){
      // Count checked radios across all questionnaires
      const checked = document.querySelectorAll('input[type="radio"]:checked').length;
      return checked;
    }

    function updateOverallProgress(){
      const total = totalQuestions();
      const done = answeredCount();
      const pct = Math.round((done / total) * 100);
      $("#progressBar").style.width = `${pct}%`;
      $("#progressLabel").textContent = `${pct}%`;
    }

    function showStep(index){
      // hide all
      for (let i=0; i<=4; i++){
        const sec = document.getElementById(`step-${i}`);
        if (sec) sec.style.display = "none";
      }
      document.getElementById(`step-${index}`).style.display = "block";

      // header bits
      buildStepper(index);
      $("#stepIntro").textContent = steps[index].intro;

      // button states
      $("#backBtn").style.visibility = index === 0 ? "hidden" : "visible";
      $("#nextBtn").textContent = index === 4 ? "Submit" : "Next";

      updateOverallProgress();
      setInitialsBadge();
    }

    function validateStep(index){
      if (index === 0){
        const initials = ($("#initials").value || "").trim();
        const consent = $("#consent").checked;
        if (!initials){
          alert("Please enter your initials.");
          $("#initials").focus();
          return false;
        }
        if (!consent){
          alert("Please tick the consent box before continuing.");
          return false;
        }
        return true;
      }

      if (index === 1){
        const phq = getAnswers("phq9", phq9Items.length);
        if (!phq){ alert("Please answer all PHQ-9 questions before continuing."); return false; }
        return true;
      }
      if (index === 2){
        const gad = getAnswers("gad7", gad7Items.length);
        if (!gad){ alert("Please answer all GAD-7 questions before continuing."); return false; }
        return true;
      }
      if (index === 3){
        const iesr = getAnswers("iesr", iesrItems.length);
        if (!iesr){ alert("Please answer all IES-R questions before continuing."); return false; }
        return true;
      }
      return true;
    }

    function fillReview(){
      const initials = ($("#initials").value || "").trim();
      const ageBand = ($("#ageBand").value || "").trim();
      const eventDesc = ($("#eventDesc").value || "").trim();
      const date = isoDate();

      const phq = getAnswers("phq9", phq9Items.length);
      const gad = getAnswers("gad7", gad7Items.length);
      const iesr = getAnswers("iesr", iesrItems.length);

      const phqSev = phqSeverity(phq.total);
      const gadSev = gadSeverity(gad.total);

      $("#reviewBox").innerHTML = `
        <strong>Initials:</strong> ${initials}<br>
        <strong>Date:</strong> ${date}<br>
        <strong>Age band:</strong> ${ageBand || "Not provided"}<br>
        ${eventDesc ? `<strong>Event (brief):</strong> ${escapeHtml(eventDesc)}<br>` : `<strong>Event (brief):</strong> Not provided<br>`}
        <div style="height:10px;"></div>
        <strong>PHQ-9:</strong> ${phq.total} (${phqSev})<br>
        <strong>GAD-7:</strong> ${gad.total} (${gadSev})<br>
        <strong>IES-R:</strong> ${iesr.total}
      `;
    }

    function escapeHtml(str){
      return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function buildEmailSummary(){
      const initials = ($("#initials").value || "").trim();
      const ageBand = ($("#ageBand").value || "").trim();
      const eventDesc = ($("#eventDesc").value || "").trim();
      const date = isoDate();

      const phq = getAnswers("phq9", phq9Items.length);
      const gad = getAnswers("gad7", gad7Items.length);
      const iesr = getAnswers("iesr", iesrItems.length);

      const phqSev = phqSeverity(phq.total);
      const gadSev = gadSeverity(gad.total);

      const lines = [
        `Initials: ${initials}`,
        `Age band: ${ageBand || "Not provided"}`,
        `Date: ${date}`,
        eventDesc ? `Event (brief): ${eventDesc}` : "Event (brief): Not provided",
        "",
        `PHQ-9 total: ${phq.total} (${phqSev})`,
        `PHQ-9 answers (Q1–Q9): ${phq.answers.join(", ")}`,
        "",
        `GAD-7 total: ${gad.total} (${gadSev})`,
        `GAD-7 answers (Q1–Q7): ${gad.answers.join(", ")}`,
        "",
        `IES-R total: ${iesr.total}`,
        `IES-R answers (Q1–Q22): ${iesr.answers.join(", ")}`
      ];

      $("#summary").value = lines.join("\n");
      $("#_subject").value = `Questionnaires – ${initials} – ${date}`;
    }

    // ---------- Init ----------
    renderQuestions("phq9Questions", phq9Items, "phq9", phqGadOptions);
    renderQuestions("gad7Questions", gad7Items, "gad7", phqGadOptions);
    renderQuestions("iesrQuestions", iesrItems, "iesr", iesrOptions);

    let currentStep = 0;
    showStep(currentStep);

    $("#initials").addEventListener("input", setInitialsBadge);

    $("#backBtn").addEventListener("click", () => {
      if (currentStep > 0){
        currentStep -= 1;
        showStep(currentStep);
      }
    });

    $("#nextBtn").addEventListener("click", () => {
      // Validate current step before moving forward/submitting
      if (!validateStep(currentStep)) return;

      // Move forward
      if (currentStep < 4){
        currentStep += 1;

        // If arriving at review, populate it
        if (currentStep === 4){
          fillReview();
        }

        showStep(currentStep);
        return;
      }

      // currentStep === 4 => SUBMIT
      // Final safety check: all answered
      const phq = getAnswers("phq9", phq9Items.length);
      const gad = getAnswers("gad7", gad7Items.length);
      const iesr = getAnswers("iesr", iesrItems.length);
      if (!phq || !gad || !iesr){
        alert("Please ensure all questionnaires are fully completed before submitting.");
        return;
      }

      buildEmailSummary();

      // Disable button to prevent double submit
      $("#nextBtn").disabled = true;
      $("#nextBtn").textContent = "Sending…";

      // Submit one time
      $("#wizardForm").submit();
    });
  </script>
</body>
</html>
